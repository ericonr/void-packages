# Template file for 'rpi-kernel'
#
# We track the latest Raspberry Pi LTS kernel as that is what is used in the
# official Raspbian distribution. This is currently 5.10:
#
# https://www.raspberrypi.org/forums/viewtopic.php?f=29&t=288234
#
# Commit hash is picked from latest tag [1], if appropriate, or from latest
# "Merge remote-tracking branch 'stable/linux-5.10.y' into rpi-5.10.y" commit.
#
# [1] https://github.com/raspberrypi/linux/releases
#
# WARNING: keep all rpi*-kernel packages in sync

_githash="86729e78125d4f3d203457940feee8bc97b11f6c"

pkgname=rpi-kernel
version=5.10.52
revision=1
archs="armv6l*"
build_style=rpi-kernel
wrksrc="linux-${_githash}"
hostmakedepends="perl kmod uboot-mkimage openssl-devel bc bison flex"
makedepends="ncurses-devel"
maintainer="Piraty <piraty1@inbox.ru>"
homepage="http://www.kernel.org"
license="GPL-2.0-only"
short_desc="Linux kernel for Raspberry Pi zero/1 (${version%.*} series)"
distfiles="https://github.com/raspberrypi/linux/archive/${_githash}.tar.gz"
checksum=a25a7dfce4c2ca5bdca39ddab5e43539d9b04900b0dbefe19f4f9b053e59968c

kernel_target=bcmrpi_defconfig

rpi-kernel-headers_package() {
	nostrip=yes
	noverifyrdeps=yes
	noshlibprovides=yes
	short_desc="${short_desc/kernel/kernel headers}"
	pkg_install() {
		vmove usr/src
		vmove usr/lib/modules/${_kernver}/build
	}
}


# support legacy systems (before rpi-kernel was split to rpi{,2,3})
# archs != armv6* are emtpy meta packages to pull the new rpi{$n}-kernel package
archs+=" armv7l* aarch64*"
case "$XBPS_TARGET_MACHINE" in
	armv6*) : ;;
	*)
		build_style=meta
		short_desc="Linux kernel for Raspberry Pi (transitional dummy package)"

		pre_configure() { : ; }
		do_configure() { : ; }
		do_build() { : ; }
		do_install() { : ; }

		case "$XBPS_TARGET_MACHINE" in
			armv7*) depends=rpi2-kernel ;;
			aarch64*) depends=rpi3-kernel ;;
		esac

		rpi-kernel-headers_package() {
			build_style=meta
			short_desc="Linux kernel headers for Raspberry Pi (transitional dummy package)"
			case "$XBPS_TARGET_MACHINE" in
				armv7*) depends=rpi2-kernel-headers ;;
				aarch64*) depends=rpi3-kernel-headers ;;
			esac
		}
		;;
esac
