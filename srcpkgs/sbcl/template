# Template file for 'sbcl'
pkgname=sbcl
version=2.2.7
revision=2
# make sure the sbcl option in maxima is enabled for the same archs
archs="i686 x86_64* armv7l aarch64 ppc64le*"
hostmakedepends="iana-etc texinfo clisp"
makedepends="libzstd-devel zlib-devel"
conf_files="/etc/sbclrc"
short_desc="Steel Bank Common Lisp"
maintainer="Leah Neukirchen <leah@vuxu.org>"
license="custom:BSD+public_domain"
homepage="http://www.sbcl.org/"
changelog="http://www.sbcl.org/news.html"
distfiles="${SOURCEFORGE_SITE}/${pkgname}/${pkgname}-${version}-source.tar.bz2"
checksum=ec98996fdaa68009d98b4d7db2189271f2ad455ec322ca95a9c6aebf08bead6d
nocross=yes
nopie=yes
_bootstrap_lisp="clisp"

do_build() {
	printf '"%s.void.%s"\n' "$version" "$revision" >version.lisp-expr
	export CFLAGS+=" -D_GNU_SOURCE -fno-omit-frame-pointer -DSBCL_HOME=/usr/lib/sbcl"
	export LINKFLAGS="$LDFLAGS"
	bash make.sh \
		"$_bootstrap_lisp" \
		--without-sb-test --with-sb-core-compression --prefix=/usr
	make -C ./doc/manual info
}

do_install() {
	SBCL_HOME="" INSTALL_ROOT="$DESTDIR/usr" sh install.sh
	vlicense COPYING LICENSE
	vconf ${FILESDIR}/sbclrc
}

sbcl-source_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" -- source files"
	pkg_install() {
		cd $wrksrc
		./clean.sh
		vmkdir usr/lib/sbcl
		vcopy src usr/lib/sbcl
	}
}
